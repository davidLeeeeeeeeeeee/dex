# DEX 主线查漏清单（更新版）

> 更新时间：2026-02-20
> 依据：当前工作区代码（consensus/db/stateDB/frost/runtime/handlers/sender）与本地定向单测

---

## 本轮新增已完成（2026-02-20）

1. 共识查询 fanout 改为固定 K，背压仅控制“是否发起新查询”
   - `consensus/queryManager.go`
   - `adaptiveQueryFanoutLocked` 不再动态收缩 fanout，改为固定 `K`
   - 背压由 `shouldBackoffForSenderPressureLocked` 控制

2. stateDB 新增批量读取与前缀扫描接口
   - `stateDB/query.go`：新增 `GetMany`、`IterateLatestByPrefix`
   - `stateDB/store_pebble.go`：新增 `pebbleStore.Get`
   - `stateDB/iface.go`：补齐 `Get` 接口定义

3. DB 层完成 state/kv 分流后的批量读取优化
   - `db/db.go`：`GetKVs` 拆分 `stateKeys/kvKeys` 批量读取（`readStateKeys/readKVKeys`）
   - `db/db.go`：`scanStateByPrefix` 改为调用 `IterateLatestByPrefix`
   - `db/db.go`：`GetMinerByIndex` 兼容 `indexToAccount` 存 account key 的场景

4. FROST runtime 接入批量读取通道
   - `frost/runtime/adapters/state_reader.go`：新增 `GetMany`
   - `frost/runtime/manager.go`、`frost/runtime/workers/withdraw_worker.go`：adapter 透传 `GetMany`
   - `frost/runtime/planning/batch_get.go`：新增批量读取辅助函数

5. FROST planner 资金可用量计算与扣减逻辑增强
   - `frost/runtime/planning/job_window_planner.go`
   - 新增单次 Tick 生命周期 `transientCache`，并在规划成功后扣减缓存余额
   - BTC UTXO 锁状态、账户链 recharge 请求改为批量读取

6. DKG share 验签路径增强
   - `frost/runtime/workers/transition_worker.go`
   - `collectAndVerifyShares` 先加载 commitments（`loadDKGCommitments`）再校验 share

7. 队列监控降噪开关已加
   - `cmd/main/main.go`
   - `monitorQueueStats` 改为 `DEX_MONITOR_QUEUE_STATS=1` 时才启动

---

## 历史主线已完成（仍有效）

1. 深度落后路径已接入 stateDB-first + 分片多节点同步
   - `consensus/syncManager.go`
   - `performDistributedStateDBSync`
   - `fetchSnapshotShardWithFallback`
   - `selectStateSyncPeers`

2. `heightDiff` 分流已细化为“<=100 / >100”
   - `heightDiff >= HardGap && heightDiff > DeepLagStateSyncThreshold` 走 stateDB-first
   - 其余走常规追块

3. 同步响应 VRF 签名集合改为强制校验
   - 发送端无签名集合会跳过该高度
   - 接收端缺失/解码失败/验签失败直接拒绝该高度

4. state snapshot 协议链路已打通
   - `types/state_snapshot_sync.go`
   - `sender/state_snapshot_sync.go`
   - `handlers/handleStateSnapshotSync.go`
   - `db/state_snapshot_sync.go`
   - `handlers/manager.go` 路由已接入

5. stateful key 严格分离已落地（无兼容路径）
   - 运行时读取：`db.Get` 对 stateful key 读 `state/live`
   - 运行时写入：VM 在 `SyncStateUpdates` 成功后不再把 stateful key 写入主库
   - 主库写队列：stateful key 不再提交到 `data/data_node_x`，改写 `state/live`
   - 关键文件：`db/db.go`、`db/write_queue.go`、`vm/executor.go`、`stateDB/update.go`

6. 严格分离后的矿工缓存读取问题已修复
   - 现象：`GetRandomMiners: no miners available`
   - 修复：`db/manage_miner.go` 改为通过 `mgr.Get(accountKey)` 读取账户；仅在 `stateDB` 未初始化测试场景回退主库

---

## 当前未关闭项（按优先级）

### P1

1. FROST 消息签名验证与重放保护默认仍关闭
   - 现状：`EnableSigVerify: false`、`EnableReplayGuard: false`
   - 影响文件：`handlers/handleFrostMsg.go`

2. 通用消息签名验证待补齐
   - 现状：`handlers/manager.go` 仍有 `TODO: 验证消息签名`

3. FROST transition / withdraw 主流程仍有关键 TODO
   - 影响文件：`frost/runtime/workers/transition_worker.go`、`frost/runtime/workers/withdraw_worker.go`
   - 典型缺口：配置化参数、transition state 提交、迁移 Job 执行、ABI 编码、地址派生等

4. FROST net handler 转发仍为占位
   - 影响文件：`frost/runtime/net/handlers.go`

### P2

5. 测试覆盖仍可继续补强
   - 已补：stateDB/db/frost runtime adapter 的批量读取与前缀扫描相关测试
   - 待补：transition/withdraw 异常注入与端到端迁移流程测试

6. 历史技术债条目仍未清零
   - `OVERENGINEERING_REVIEW.md` 中的拆分与清理项仍有残留
   - 旧注释/乱码文本仍需清理

---

## 建议推进顺序（最新版）

1. P1：优先落地 FROST 签名验证 + replay guard（含配置化开关）。
2. P1：补通用消息签名校验链路（`handlers/manager.go`）。
3. P1：收敛 transition / withdraw 关键 TODO（先 transition state，再 migration job）。
4. P2：补 transition/withdraw 失败路径与端到端用例。
5. P2：按模块分批清理历史技术债与乱码注释。

---

## 本地验证记录

- `go test ./stateDB -run "TestIterateLatestByPrefix|TestGetMany" -count=1`：通过
- `go test ./db -run "TestSyncStateUpdatesMirrorsStatefulKeys|TestSyncStateUpdatesMirrorsDeletes|TestStateDBConfigIsAppliedFromMainConfig|TestGetKVsBatchesStateAndKV" -count=1`：通过
- `go test ./frost/runtime/... -count=1`：通过
- `go test ./consensus -run "TestStateSnapshot|TestDistributedState|TestFetchSnapshot|TestSelectState" -count=1`：通过
- `go test ./consensus -count=1`：本机超时（184s），未完成全量回归
