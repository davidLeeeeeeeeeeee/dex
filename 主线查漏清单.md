# DEX 主线查漏清单（更新版）

> 更新时间：2026-02-19
> 依据：当前工作区代码（consensus/db/handlers/types/sender）与最近会话改动

---

## 本次已同步到清单的变更（已完成）

1. consensus 深度落后路径已接入 stateDB-first + 分片多节点同步
   - `consensus/syncManager.go`
   - `performDistributedStateDBSync`
   - `fetchSnapshotShardWithFallback`
   - `selectStateSyncPeers`
2. `heightDiff` 分流已细化为“<=100 / >100”
   - `heightDiff >= HardGap && heightDiff > DeepLagStateSyncThreshold` 走 stateDB-first
   - 其余仍走常规追块
3. 同步响应 VRF 签名集合改为强制校验
   - 发送端无签名集合会跳过该高度
   - 接收端缺失/解码失败/验签失败直接拒绝该高度
4. state snapshot 协议链路已打通
   - `types/state_snapshot_sync.go`
   - `sender/state_snapshot_sync.go`
   - `handlers/handleStateSnapshotSync.go`
   - `db/state_snapshot_sync.go`
   - `handlers/manager.go` 新增路由
5. consensus 已新增对应单测
   - `consensus/state_snapshot_sync_test.go`
   - 覆盖 peer 选择、分页回退、多节点分片同步落地
6. stateful key 严格分离已落地（无兼容路径）
   - 运行时读取：`db.Get` 对 stateful key 改为读 `state/live`
   - 运行时写入：VM 在 `SyncStateUpdates` 成功后不再把 stateful key 写入主库
   - 主库写队列：stateful key 不再提交到 `data/data_node_x`，改写 `state/live`
   - 关键文件：`db/db.go`、`db/write_queue.go`、`vm/executor.go`、`stateDB/update.go`
7. 严格分离后的矿工缓存读取问题已修复
   - 现象：`GetRandomMiners: no miners available`
   - 原因：矿工缓存仍从主库读取 `account_*`（已迁到 `state/live`）
   - 修复：`db/manage_miner.go` 改为通过 `mgr.Get(accountKey)` 读取账户；仅在 `stateDB` 未初始化的测试场景回退主库读取

---

## 当前未关闭项（按优先级）

### P1

1. FROST 消息签名验证与重放保护默认关闭
- 现状：仍有 `EnableSigVerify: false`、`EnableReplayGuard: false`。
- 风险：生产安全面较大。
- 影响文件：`handlers/handleFrostMsg.go`。

2. 通用消息签名验证待补齐
- 现状：`handlers/manager.go` 仍有“TODO: 验证消息签名”。
- 风险：请求来源信任边界不完整。

3. FROST transition worker 硬编码/TODO 较多
- 现状：关键迁移流程仍有多处未实现。
- 影响文件：`vm/transition_worker.go`（及相关模块）。

4. stateDB 与同步链路测试仍可继续补强
- 已完成：consensus 新增 3 个 state snapshot 相关用例。
- 待补：异常注入、节点重启恢复、大规模压力、跨版本兼容、严格分离后的启动烟测（含矿工缓存/广播路径）。

### P2

5. 历史技术债条目仍未清零
- `OVERENGINEERING_REVIEW.md` 中的拆分与清理项仍有残留。
- `handlers/tx_utils.go` 依赖注入改造未完成。
- 部分旧注释/乱码文本需清理。

---

## 建议推进顺序（最新版）

1. P1：优先打开并落地 FROST 签名验证 + replay guard。
2. P1：补“失败场景”同步用例（分页中断、全部 peer 失败、恢复重试）。
3. P1：继续收敛 transition worker 的硬编码与 TODO。
4. P2：按模块分批清理历史技术债。

---

## 备注

- 本清单已反映本轮已完成的 consensus/stateDB 同步主线改造。
- 当前按你的要求未做全量回归，仅做了关键路径定向验证。
- 若你希望，我下一步可以把每个未关闭项拆成“可直接执行”的 Issue 模板（含验收标准与影响文件列表）。
