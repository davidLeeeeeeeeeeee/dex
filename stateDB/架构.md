# StateDB 鏂版灦鏋勶紙Checkpoint 鐗堟湰鍖?+ 姣忛珮搴︾洿鍐欙級

## 1. 鏍稿績鍐崇瓥

1. 鐗堟湰绠＄悊浣跨敤 Pebble `Checkpoint`銆?2. 姣忎釜楂樺害鍐欏叆鏃剁洿鎺ヨ惤 `stateDB`锛坵rite-through锛夛紝涓嶅啀璧板唴瀛樼獥鍙ｇ疮绉€?3. 鍒犻櫎涓氬姟灞?WAL锛坄stateDB/wal.go` 鐩稿叧閾捐矾锛夈€?4. 淇濈暀鍒嗙墖锛坰hard锛夌敤浜庡苟琛屽悓姝ヤ笌鍒嗛〉瀵煎嚭銆?
## 2. 鍏ㄥ眬渚濊禆妫€鏌ョ粨鏋滐紙Key 褰卞搷闈級

閽堝鍐呴儴 key 鏍煎紡鍋氫簡鍏ㄥ眬妫€绱紝缁撹濡備笅锛?
1. 鏃ф牸寮?key锛坄s1|snap`銆乣s1|ovl`銆乣meta:h2seq` 绛夛級鍙湪 `stateDB` 鍖呭唴鍜屽叾娴嬭瘯涓娇鐢ㄣ€?2. 涓氬姟妯″潡锛坄vm`銆乣db`銆乣witness`銆乣consensus` 绛夛級涓嶇洿鎺ヤ緷璧?`stateDB` 鍐呴儴 key 瀛楃涓层€?3. 涓氬姟妯″潡渚濊禆鐨勬槸 `keys/keys.go` 閲屼笟鍔?key锛堝 `v1_account_*`銆乣v1_winfo_*`锛夛紝鑰屼笉鏄?`stateDB/keys.go` 鐨勫唴閮ㄧ紪鐮併€?
鍥犳锛宍stateDB` 鍐呴儴 key 鍙畨鍏ㄩ噸鏋勶紝浣嗗簲淇濇寔缁熶竴鍛藉悕椋庢牸锛岄伩鍏嶅悗缁淮鎶ゆ贩涔便€?
涓氬姟 key 鐨勫敮涓€娓呭崟瀹氫箟浣嶇疆锛?
1. `keys/statedb_business_keys.go`
2. 浠ｇ爜鍏ュ彛锛歚keys.StateDBBusinessKeySpecs()`

## 3. 缁熶竴鍚庣殑 Key 璁捐锛坴1_sdb_*锛?
涓哄拰鍏ㄥ眬 `v1_*` 椋庢牸涓€鑷达紝`stateDB` 鍐呴儴 key 缁熶竴鏀逛负 `v1_sdb_*` 鍛藉悕锛?
1. 鐘舵€佹暟鎹敭锛歚v1_sdb_state_<shard>_<biz_key>`
2. 楂樺害鍒板簭鍙凤細`v1_sdb_meta_h2seq_<height_020d>`
3. 搴忓彿鍒伴珮搴︼細`v1_sdb_meta_seq2h_<seq_020d>`
4. 鏈€鏂伴珮搴︼細`v1_sdb_meta_last_applied_height`
5. 鏈€鏂?checkpoint 楂樺害锛歚v1_sdb_cp_latest`
6. checkpoint 绱㈠紩椤癸紙鍙€夛級锛歚v1_sdb_cp_h_<height_020d>`

璇存槑锛?
1. `biz_key` 鏄笟鍔″畬鏁?key锛堝 `v1_account_xxx`銆乣v1_wvote_xxx`锛夈€?2. 鍒嗛〉鎵弿鎸夊墠缂€ `v1_sdb_state_<shard>_`銆?3. 楂樺害/搴忓彿缁熶竴闆跺～鍏?20 浣嶏紝淇濊瘉瀛楀吀搴忓彲姣旇緝銆?4. 鏂拌璁′笉鍐嶄娇鐢?`|` 鍒嗛殧绗︼紝椋庢牸涓庝粨搴撳叾浣?key 涓€鑷淬€?
## 4. 瀛樺偍鐩綍缁撴瀯

1. 涓荤姸鎬佸簱锛歚<state_dir>/live`
2. 鐗堟湰鐩綍锛歚<state_dir>/checkpoints/h_<height>`

`live` 淇濆瓨鏈€鏂扮姸鎬侊紝鍘嗗彶鐗堟湰鐢?checkpoint 鐩綍鎻愪緵銆?
## 5. 鍐欒矾寰勶紙姣忛珮搴︾洿鍐欙級

`ApplyAccountUpdate(height, kvs...)`锛?
1. 浣跨敤 `keys.IsStatefulKey` 杩囨护杈撳叆銆?2. 瀵规瘡涓姸鎬侀敭鐩存帴鍐欏叆 `v1_sdb_state_<shard>_<biz_key>`锛坰et/del锛夈€?3. 鍚屾壒鍐欏叆 `h2seq/seq2h/last_applied_height` 鍏冩暟鎹€?4. 鎻愪氦鎴愬姛鍚庢寜绛栫暐瑙﹀彂 checkpoint銆?
涓嶅啀淇濈暀锛?
1. `mem.apply` 鍐呭瓨绐楀彛銆?2. `FlushAndRotate` overlay 鍥哄寲妯″紡銆?3. 涓氬姟灞?WAL append/replay/remove銆?
## 6. Checkpoint 绛栫暐

### 6.1 瑙﹀彂

寤鸿浣跨敤 Epoch 杈圭晫瑙﹀彂锛?
1. `height % CheckpointEvery == 0` 鏃跺垱寤?checkpoint銆?
### 6.2 涓€鑷存€?
鎵ц checkpoint 鏃惰皟鐢?Pebble `WithFlushedWAL()`銆?
璇存槑锛?
1. 杩欓噷鐨?WAL 鎸?Pebble 寮曟搸鍐呴儴 WAL锛屼笉鏄鍒犻櫎鐨勪笟鍔″眰 WAL銆?2. 鐩殑鏄繚璇?checkpoint 鍖呭惈璋冪敤鍓嶅凡鎻愪氦鍐欏叆銆?
### 6.3 淇濈暀

1. 鍙繚鐣欐渶杩?`CheckpointKeep` 涓?checkpoint銆?2. 瓒呭嚭涓婇檺鍗冲垹闄ゆ渶鑰佺洰褰曘€?
## 7. 璇昏矾寰?
### 7.1 鏈€鏂扮姸鎬?
`Get(key)`锛?
1. 璁＄畻 shard銆?2. 璇诲彇 `v1_sdb_state_<shard>_<biz_key>`銆?
### 7.2 鍘嗗彶鐘舵€?
鎸夐珮搴﹁鍙栨椂锛?
1. 閫夋嫨涓嶉珮浜庣洰鏍囬珮搴︾殑鏈€杩?checkpoint銆?2. 鎵撳紑璇?checkpoint 鐨勫彧璇?DB銆?3. 鎸夊悓鏍?key 瑙勫垯璇诲彇銆?
## 8. 鍒嗙墖鍚屾涓庡鍑?
鍒嗙墖鑳藉姏淇濈暀锛?
1. 鍓嶇紑鎵弿锛歚v1_sdb_state_<shard>_`
2. 鏀寔 `pageSize + pageToken`
3. 澶?shard 骞惰鎷夊彇

## 9. 閰嶇疆椤硅皟鏁?
淇濈暀/鏂板锛?
1. `DataDir`
2. `ShardHexWidth`
3. `PageSize`
4. `CheckpointEvery`
5. `CheckpointKeep`

鍒犻櫎锛?
1. `UseWAL`
2. 涓氬姟 WAL 鐩稿叧閰嶇疆

寤鸿锛?
1. `VersionsToKeep` 璇箟杩佺Щ涓?`CheckpointKeep`锛岄伩鍏嶉噸澶嶅惈涔夈€?
## 10. 杩佺Щ姝ラ

1. 鍦?`stateDB/keys.go` 鏂板 `v1_sdb_*` key 鐢熸垚鍑芥暟銆?2. 鏀瑰啓璇诲啓璺緞鍒版柊 key 瑙勫垯銆?3. 鍋氫竴娆″叏閲忕姸鎬侀噸鍐欏埌 `live`銆?4. 鐢熸垚棣栦釜 checkpoint 浣滀负鍩虹嚎銆?5. 涓嬬嚎 `mem_window`銆乣overlay`銆乣WAL` 鐩稿叧浠ｇ爜涓庢枃妗ｃ€?
## 11. 楠屾敹鏍囧噯

1. 宕╂簝閲嶅惎鍚庝笉涓㈠凡鎻愪氦楂樺害鐘舵€併€?2. `Get` 缁撴灉鍜屼富搴撶姸鎬佷竴鑷淬€?3. checkpoint 鍘嗗彶璇诲彇姝ｇ‘銆?4. 鎸?shard 鍒嗛〉瀵煎嚭鍙苟琛屻€佸彲缁紶銆?5. 鍐呭瓨宄板€兼樉钁椾綆浜庢棫鏋舵瀯銆?
