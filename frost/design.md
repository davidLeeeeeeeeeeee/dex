# Frost 模块设计文档

## 1. 概述
Frost 模块负责去中心化资产管理和跨链互操作性。它利用门限签名方案 (TSS) 和多方计算 (MPC)，特别是利用 ROAST (Robust Asynchronous Schnorr Threshold) 协议的鲁棒性，管理各种链（BTC, ETH, SOL, TRX, BNB）上的资产托管。

## 2. 架构原则
1.  **独立性**：Frost 模块独立于主共识引擎运行。它观察共识状态（已确认的交易）并异步执行请求（提现、权力交接）。
2.  **解耦**：使用接口抽象特定链的逻辑（例如 UTXO 与账户模型）和签名方案。
3.  **可扩展性**：设计用于处理大型验证者集合（最多 10,000 个矿工），通过利用子集（例如 1,000 个随机矿工）作为活跃签名委员会来优化性能（解决 ROAST 的 $O(n^2)$ 复杂度问题）。

## 3. 核心组件

### 3.1. 参与者管理器 (Participant Manager)
*   **角色**：管理源自共识层的活跃参与者（矿工）集合。
*   **功能**：
    *   跟踪前 10,000 个共识矿工。
    *   选择活跃签名委员会（例如随机 1,000 个子集）以减少通信开销。
    *   当矿工集合发生显著变化（例如 >20% 变动）时，处理“权力交接”逻辑。

### 3.2. 资产管理器 (Chain Adapters)
抽象特定链的逻辑。
*   **比特币 (BTC)**：
    *   管理 UTXO。
    *   构建交易。
    *   聚合公钥以生成地址。
*   **智能合约链 (ETH, SOL, TRX, BNB)**：
    *   使用专用智能合约进行资产托管。
    *   合约存储当前委员会的聚合公钥。
    *   只有在验证了委员会的有效门限签名后，才会释放资产。

### 3.3. 签名聚合器 (ROAST 协调器)
*   **角色**：充当 ROAST 协调器 (Orchestrator)，是 FROST 协调器逻辑的封装层。
*   **算法**：ROAST (Robust Asynchronous Schnorr Threshold)。
*   **工作流程**：
    1.  **会话初始化**：协调器发起消息签名会话。
    2.  **子集选择**：从活跃池中选择 $t$（阈值）个参与者的子集。
    3.  **FROST 轮次**：尝试与选定的子集进行标准的 FROST 签名轮次。
        *   **承诺**：向子集请求 $R_i$。
        *   **签名**：将聚合的 $R$ 发送给子集，请求 $S_i$。
    4.  **故障处理 (鲁棒性)**：
        *   如果子集中的任何参与者无响应或恶意（超时或无效份额），协调器会**自动切换**到不同的子集。
        *   此过程重复进行，直到生成有效签名，确保即使在异步网络条件下也能保持活性。
*   **风险缓解**：
    *   **恶意聚合器**：如果聚合器本身超时或审查，共识层将触发视图更改以选择新的聚合器。

## 4. 关键流程

### 4.1. 提现流程
1.  **请求**：用户发起提现；共识验证并确认请求。
2.  **排队**：Frost 模块从共识状态中获取已确认的提现请求。
3.  **签名**：
    *   聚合器与活跃委员会启动 ROAST 协议。
    *   为提现交易生成签名。
4.  **广播**：签名后的交易被广播到目标链。
5.  **确认**：监控链上确认状态。

### 4.2. 权力交接 (密钥轮换)
*   **触发**：当验证者集合发生显著变化（例如前 10,000 个矿工中有 >20% 发生变化）时发生。
*   **流程**：
    1.  **DKG (分布式密钥生成)**：新委员会生成新的聚合公钥。
    2.  **资产迁移**：
        *   **BTC**：构建交易将所有 UTXO 从旧地址移动到新地址。由旧委员会签名。
        *   **合约链**：调用托管合约上的 `updateSigners(newPublicKey)`。由旧委员会签名。
*   **约束**：在权力交接的关键阶段，普通提现可能会暂停或排队，以确保原子性。

## 5. 数据结构与存储

### 5.1. 防重放与防双花 (Nonce & UTXO)
*   **ETH/SOL/TRX/BNB (账户模型)**：
    *   **机制**：使用 **Nonce**。
    *   **实现**：Frost 模块必须维护每个链上托管账户的当前 Nonce 值。每次生成提现交易时，Nonce 递增。
    *   **防双花**：目标链节点会拒绝 Nonce 重复或乱序的交易。
*   **BTC (UTXO 模型)**：
    *   **机制**：使用 **UTXO (Unspent Transaction Output)**。
    *   **实现**：Frost 模块必须维护一个**已确认 UTXO 集合**。
    *   **防双花**：
        1.  构建交易时，必须引用特定的、未花费的 UTXO 作为输入。
        2.  一旦交易被广播并打包，该 UTXO 即被标记为“已花费”。
        3.  任何尝试再次使用该 UTXO 的交易（即使签名有效）都会被比特币网络节点拒绝，从而防止双花。
    *   **并发控制**：在构建交易时，必须**锁定**所选用的 UTXO，防止其他并发的提现请求使用相同的 UTXO。

### 5.2. 配置
*   **Gas/手续费管理**：
    *   `config.json`：存储 Gas 价格策略。
    *   **策略**：固定费率（例如年平均值的 300%）以确保快速打包，通过治理或定期软件更新进行更新。

## 6. 接口 (RPC/API)

*   `GetCurrentCommittee()`：返回当前活跃签名者列表和聚合公钥。
*   `GetWithdrawalStatus(txId)`：返回特定提现的状态。
*   `GetAggregatorInfo()`：返回当前聚合器身份和状态。

## 7. 安全考虑

*   **异步安全性**：协议必须在异步网络条件下是安全的。ROAST 通过确保活性来提供这一点，只要有阈值 $t$ 个诚实节点即可。
*   **双花**：严格的 nonce 管理和 UTXO 跟踪（针对 BTC）以防止双花。
*   **活性**：如果聚合器失败，协议必须立即切换到备份聚合器。

## 8. 未来路线图
*   **可扩展性优化**：进一步优化 ROAST 以适应更大的委员会或实施分层签名。
*   **更多链**：模块化设计允许通过实现 Chain Adapter 接口来添加对新链的支持。
