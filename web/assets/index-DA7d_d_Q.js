(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))c(d);new MutationObserver(d=>{for(const l of d)if(l.type==="childList")for(const i of l.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function n(d){const l={};return d.integrity&&(l.integrity=d.integrity),d.referrerPolicy&&(l.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?l.credentials="include":d.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function c(d){if(d.ep)return;d.ep=!0;const l=n(d);fetch(d.href,l)}})();const o={nodes:[],customNodes:[],selected:new Set,auto:!1,includeBlock:!1,includeFrost:!1,intervalMs:5e3,timer:null},s={refreshBtn:document.getElementById("refreshBtn"),autoToggle:document.getElementById("autoToggle"),intervalSelect:document.getElementById("intervalSelect"),includeBlock:document.getElementById("includeBlock"),includeFrost:document.getElementById("includeFrost"),nodeInput:document.getElementById("nodeInput"),addNodeBtn:document.getElementById("addNodeBtn"),selectAllBtn:document.getElementById("selectAllBtn"),clearBtn:document.getElementById("clearBtn"),nodeList:document.getElementById("nodeList"),nodeCount:document.getElementById("nodeCount"),cards:document.getElementById("cards"),lastUpdate:document.getElementById("lastUpdate"),statusLine:document.getElementById("statusLine"),elapsedLine:document.getElementById("elapsedLine"),defaultInfo:document.getElementById("defaultInfo"),modalOverlay:document.getElementById("modalOverlay"),modalTitle:document.getElementById("modalTitle"),modalContent:document.getElementById("modalContent"),closeModal:document.getElementById("closeModal")},y={custom:"dex_explorer_custom_nodes",selected:"dex_explorer_selected_nodes"},b=new Intl.NumberFormat("en-US");S();function S(){T(),x(),$()}function x(){s.refreshBtn.addEventListener("click",I),s.autoToggle.addEventListener("change",e=>{o.auto=e.target.checked,_()}),s.intervalSelect.addEventListener("change",e=>{o.intervalMs=Number(e.target.value),_()}),s.includeBlock.addEventListener("change",e=>{o.includeBlock=e.target.checked}),s.includeFrost.addEventListener("change",e=>{o.includeFrost=e.target.checked}),s.addNodeBtn.addEventListener("click",w),s.selectAllBtn.addEventListener("click",O),s.clearBtn.addEventListener("click",H),s.closeModal.addEventListener("click",B),s.modalOverlay.addEventListener("click",e=>{e.target===s.modalOverlay&&B()})}function T(){o.customNodes=k(y.custom,[]);const e=k(y.selected,[]);o.selected=new Set(e)}function $(){f("Loading defaults..."),fetch("/api/nodes").then(e=>e.json()).then(e=>{const t=Array.isArray(e.nodes)?e.nodes:[];o.nodes=M(t,o.customNodes),o.selected.size===0&&o.nodes.length>0&&o.nodes.slice(0,3).forEach(n=>o.selected.add(n)),g(),s.defaultInfo.textContent=`Default ${e.base_port} + ${e.count}`,f("Defaults ready")}).catch(e=>{f(`Failed to load defaults: ${e.message}`),g()})}function M(e,t){const n=new Set;return e.forEach(c=>n.add(v(c))),t.forEach(c=>n.add(v(c))),Array.from(n).filter(Boolean)}function v(e){return String(e||"").trim().replace(/^https?:\/\//,"").replace(/\/$/,"")}function g(){s.nodeList.innerHTML="",o.nodes.forEach(e=>{const t=document.createElement("label");t.className="node-item";const n=document.createElement("input");n.type="checkbox",n.checked=o.selected.has(e),n.addEventListener("change",()=>{n.checked?o.selected.add(e):o.selected.delete(e),E(),L()});const c=document.createElement("span");c.textContent=e,t.appendChild(n),t.appendChild(c),s.nodeList.appendChild(t)}),L()}function L(){s.nodeCount.textContent=`${o.selected.size} selected`}function w(){const e=v(s.nodeInput.value);e&&(o.nodes.includes(e)||(o.nodes.push(e),o.customNodes.push(e),A()),o.selected.add(e),E(),s.nodeInput.value="",g())}function O(){o.nodes.forEach(e=>o.selected.add(e)),E(),g()}function H(){o.selected.clear(),E(),g()}function A(){localStorage.setItem(y.custom,JSON.stringify(o.customNodes))}function E(){localStorage.setItem(y.selected,JSON.stringify(Array.from(o.selected))),L()}function I(){if(o.selected.size===0){N("Select at least one node to refresh.");return}f("Refreshing...");const e={nodes:Array.from(o.selected),include_block:o.includeBlock,include_frost:o.includeFrost};fetch("/api/summary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(t=>t.json()).then(t=>{F(t),f("Snapshot updated")}).catch(t=>{N(`Failed to load summary: ${t.message}`),f("Snapshot failed")})}function F(e){s.cards.innerHTML="";const t=Array.isArray(e.nodes)?e.nodes:[];if(t.length===0){N("No data returned.");return}t.forEach((n,c)=>{const d=document.createElement("div");d.className="card",d.style.animationDelay=`${c*30}ms`;const l=document.createElement("h3");l.textContent=n.address||"unknown";const i=document.createElement("div");i.className="status-line";const u=document.createElement("span");u.className=`status-dot ${P(n)}`;const p=document.createElement("span");p.textContent=n.error?"error":n.status||"unknown",i.appendChild(u),i.appendChild(p);const a=document.createElement("div");if(a.className="meta",a.appendChild(r("Current height",m(n.current_height))),a.appendChild(r("Last accepted",m(n.last_accepted_height))),a.appendChild(r("Height delta",m(Math.max(0,(n.current_height??0)-(n.last_accepted_height??0))))),a.appendChild(r("Latency",`${n.latency_ms||0} ms`)),n.info&&a.appendChild(r("Info",n.info)),n.error&&a.appendChild(r("Error",n.error)),n.block){const h=n.block;a.appendChild(r("Block hash",C(h.block_hash))),a.appendChild(r("Miner",h.miner||"-")),a.appendChild(r("Tx count",m(h.tx_count))),h.accumulated_reward&&a.appendChild(r("Reward",h.accumulated_reward))}if(n.frost_metrics){const h=n.frost_metrics;a.appendChild(r("Frost jobs",`${m(h.frost_jobs)} | ${m(h.frost_withdraws)}`)),a.appendChild(r("Goroutines",m(h.num_goroutine)))}d.appendChild(l),d.appendChild(i),d.appendChild(a),d.addEventListener("click",()=>U(n.address)),s.cards.appendChild(d)}),s.lastUpdate.textContent=e.generated_at?`Updated ${e.generated_at}`:"Updated",s.elapsedLine.textContent=e.elapsed_ms?`Elapsed ${e.elapsed_ms} ms`:""}function N(e){s.cards.innerHTML=`<div class="empty-state">${e}</div>`}function P(e){return e.error?"status-bad":e.status&&e.status.toLowerCase()==="ok"?"status-good":"status-warn"}function U(e){s.modalOverlay.style.display="flex",s.modalTitle.textContent=`Node: ${e}`,s.modalContent.innerHTML=`<div class="empty-state">Loading details for ${e}...</div>`,fetch(`/api/node/details?address=${encodeURIComponent(e)}`).then(t=>t.json()).then(t=>{j(t)}).catch(t=>{s.modalContent.innerHTML=`<div class="empty-state">Error: ${t.message}</div>`})}function j(e){s.modalContent.innerHTML="";const t=document.createElement("div");if(t.className="meta",t.appendChild(r("Address",e.address)),t.appendChild(r("Status",e.status||"-")),t.appendChild(r("Current height",m(e.current_height))),t.appendChild(r("Last accepted",m(e.last_accepted_height))),e.info&&t.appendChild(r("Info",e.info)),e.error&&t.appendChild(r("Error",e.error)),e.block){const l=e.block;t.appendChild(r("Block hash",l.block_hash||"-")),t.appendChild(r("Proposer",l.miner||"-")),t.appendChild(r("Tx count",m(l.tx_count)))}const n=document.createElement("div");n.className="log-container",n.innerHTML="<h4>Recent Logs</h4>";const c=document.createElement("div");c.className="log-list",e.logs&&e.logs.length>0?(e.logs.forEach(l=>{const i=document.createElement("div");i.className="log-line";const u=document.createElement("span");u.className="log-time",u.textContent=l.timestamp;const p=document.createElement("span");p.className=`log-level ${l.level}`,p.textContent=l.level;const a=document.createElement("span");a.className="log-msg",a.textContent=l.message,i.appendChild(u),i.appendChild(p),i.appendChild(a),c.appendChild(i)}),setTimeout(()=>{c.scrollTop=c.scrollHeight},10)):c.innerHTML='<div class="muted">No logs available.</div>',n.appendChild(c);const d=document.createElement("div");if(d.className="log-container",d.innerHTML="<h4>Recent Blocks (Top 50)</h4>",e.recent_blocks&&e.recent_blocks.length>0){const l=document.createElement("table");l.className="block-table",l.innerHTML=`
      <thead>
        <tr>
          <th>Height</th>
          <th>Hash</th>
          <th>Tx Count</th>
          <th>Miner</th>
          <th>Reward</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    `;const i=l.querySelector("tbody");e.recent_blocks.forEach(u=>{const p=document.createElement("tr");p.innerHTML=`
        <td>${m(u.height)}</td>
        <td title="${u.block_hash}">${C(u.block_hash,12)}</td>
        <td>${m(u.tx_count)}</td>
        <td title="${u.miner}">${C(u.miner,12)}</td>
        <td>${u.accumulated_reward?C(u.accumulated_reward,10):"-"}</td>
      `,i.appendChild(p)}),d.appendChild(l)}else d.innerHTML+='<div class="muted">No recent blocks available.</div>';s.modalContent.appendChild(t),s.modalContent.appendChild(d),s.modalContent.appendChild(n)}function B(){s.modalOverlay.style.display="none"}function r(e,t){const n=document.createElement("div");n.className="kv";const c=document.createElement("span");c.textContent=e;const d=document.createElement("span");return d.textContent=t||"-",n.appendChild(c),n.appendChild(d),n}function C(e,t=16){return e?e.length<=t?e:`${e.slice(0,t)}...`:"-"}function m(e){return e==null?"-":typeof e=="string"?e:b.format(e)}function _(){o.timer&&(clearInterval(o.timer),o.timer=null),o.auto&&(o.timer=setInterval(I,o.intervalMs))}function f(e){s.statusLine.textContent=e}function k(e,t){try{const n=localStorage.getItem(e);return n?JSON.parse(n)??t:t}catch{return t}}
